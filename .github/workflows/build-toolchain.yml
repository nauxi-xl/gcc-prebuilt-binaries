# .github/workflows/build-toolchain.yml
name: Build Custom Cross-Compiler

on:
  workflow_dispatch:
    inputs:
      toolchain_type:
        description: 'Toolchain type'
        required: true
        default: 'gcc'
        type: choice
        options:
          - gcc
          - llvm
      
      target_arch:
        description: 'Target architecture (e.g., x86_64-elf, aarch64-none-elf)'
        required: true
        default: 'x86_64-elf'
        type: string
      
      gcc_version:
        description: 'GCC version (for GCC toolchain)'
        required: false
        default: '13.2.0'
        type: string
      
      binutils_version:
        description: 'Binutils version (for GCC toolchain)'
        required: false
        default: '2.42'
        type: string
      
      llvm_version:
        description: 'LLVM version (for LLVM toolchain)'
        required: false
        default: '17.0.6'
        type: string
      
      install_prefix:
        description: 'Installation prefix (relative to workspace)'
        required: false
        default: 'install'
        type: string
      
      configure_flags:
        description: 'Additional configure/cmake flags (JSON format)'
        required: false
        default: '{}'
        type: string
      
      enable_languages:
        description: 'Languages to enable (GCC only)'
        required: false
        default: 'c,c++'
        type: string
      
      build_type:
        description: 'Build type (Release/Debug/RelWithDebInfo)'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
          - RelWithDebInfo
          - MinSizeRel
      
      jobs:
        description: 'Number of parallel jobs'
        required: false
        default: '4'
        type: string
      
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean
      
      cache_dependencies:
        description: 'Cache downloaded dependencies'
        required: false
        default: true
        type: boolean

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:22.04
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Parse input flags
      id: parse-flags
      run: |
        # Parse JSON configure flags
        echo "CONFIGURE_FLAGS_JSON='${{ github.event.inputs.configure_flags }}'" >> $GITHUB_ENV
        
        # Set toolchain-specific variables
        echo "TOOLCHAIN_TYPE='${{ github.event.inputs.toolchain_type }}'" >> $GITHUB_ENV
        echo "TARGET_ARCH='${{ github.event.inputs.target_arch }}'" >> $GITHUB_ENV
        echo "INSTALL_PREFIX='$(pwd)/${{ github.event.inputs.install_prefix }}'" >> $GITHUB_ENV
        echo "BUILD_JOBS='${{ github.event.inputs.jobs }}'" >> $GITHUB_ENV
        
        # Create flags file
        mkdir -p .github/tmp
        echo '${{ github.event.inputs.configure_flags }}' > .github/tmp/flags.json
        
        # Extract specific flags from JSON
        if command -v jq >/dev/null 2>&1; then
          sudo apt-get install -y jq
        fi
        
        # Try to parse JSON if jq is available
        if [ -f .github/tmp/flags.json ] && command -v jq >/dev/null 2>&1; then
          jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' .github/tmp/flags.json > .github/tmp/flags.env
        fi
    
    - name: Setup build environment
      run: |
        # Update and install common dependencies
        apt-get update
        apt-get install -y \
          build-essential \
          software-properties-common \
          wget \
          curl \
          git \
          tar \
          gzip \
          bzip2 \
          xz-utils \
          file \
          python3 \
          python3-pip \
          ninja-build \
          cmake \
          pkg-config \
          libtool \
          automake \
          autoconf \
          flex \
          bison \
          texinfo \
          help2man
        
        # Install toolchain-specific dependencies
        if [ "$TOOLCHAIN_TYPE" = "gcc" ]; then
          apt-get install -y \
            libgmp-dev \
            libmpfr-dev \
            libmpc-dev \
            libisl-dev \
            zlib1g-dev
        elif [ "$TOOLCHAIN_TYPE" = "llvm" ]; then
          apt-get install -y \
            libxml2-dev \
            libncurses5-dev \
            libedit-dev \
            swig \
            libpython3-dev \
            libffi-dev \
            libz3-dev \
            liblzma-dev
        fi
        
        # Install jq for JSON parsing
        apt-get install -y jq
    
    - name: Cache dependencies
      if: ${{ inputs.cache_dependencies }}
      uses: actions/cache@v3
      with:
        path: |
          ${{ github.workspace }}/.cache/downloads
          ${{ github.workspace }}/.cache/build
        key: ${{ runner.os }}-${{ inputs.toolchain_type }}-${{ inputs.target_arch }}-${{ hashFiles('scripts/*.sh', 'configs/*.conf') }}
    
    - name: Build GCC/Binutils toolchain
      if: ${{ inputs.toolchain_type == 'gcc' }}
      run: |
        # Set environment variables
        export TARGET="${{ inputs.target_arch }}"
        export PREFIX="$INSTALL_PREFIX"
        export GCC_VERSION="${{ inputs.gcc_version }}"
        export BINUTILS_VERSION="${{ inputs.binutils_version }}"
        export LANGUAGES="${{ inputs.enable_languages }}"
        export BUILD_TYPE="${{ inputs.build_type }}"
        export JOBS="$BUILD_JOBS"
        
        # Parse additional flags
        ADDITIONAL_FLAGS=""
        if [ -f .github/tmp/flags.json ]; then
          ADDITIONAL_FLAGS=$(jq -r '.configure_flags // empty' .github/tmp/flags.json)
        fi
        
        # Run GCC build script
        chmod +x scripts/build-gcc.sh
        ./scripts/build-gcc.sh \
          --target "$TARGET" \
          --prefix "$PREFIX" \
          --gcc-version "$GCC_VERSION" \
          --binutils-version "$BINUTILS_VERSION" \
          --languages "$LANGUAGES" \
          --build-type "$BUILD_TYPE" \
          --jobs "$JOBS" \
          --flags "$ADDITIONAL_FLAGS"
    
    - name: Build LLVM/Clang toolchain
      if: ${{ inputs.toolchain_type == 'llvm' }}
      run: |
        # Set environment variables
        export TARGET="${{ inputs.target_arch }}"
        export PREFIX="$INSTALL_PREFIX"
        export LLVM_VERSION="${{ inputs.llvm_version }}"
        export BUILD_TYPE="${{ inputs.build_type }}"
        export JOBS="$BUILD_JOBS"
        
        # Parse additional flags
        ADDITIONAL_FLAGS=""
        if [ -f .github/tmp/flags.json ]; then
          ADDITIONAL_FLAGS=$(jq -r '.cmake_flags // empty' .github/tmp/flags.json)
        fi
        
        # Run LLVM build script
        chmod +x scripts/build-llvm.sh
        ./scripts/build-llvm.sh \
          --target "$TARGET" \
          --prefix "$PREFIX" \
          --version "$LLVM_VERSION" \
          --build-type "$BUILD_TYPE" \
          --jobs "$JOBS" \
          --flags "$ADDITIONAL_FLAGS"
    
    - name: Verify toolchain installation
      run: |
        export PREFIX="$INSTALL_PREFIX"
        export TARGET="${{ inputs.target_arch }}"
        
        echo "=== Verifying toolchain ==="
        echo "Install prefix: $PREFIX"
        echo "Target: $TARGET"
        
        # Check if binaries exist
        if [ -d "$PREFIX/bin" ]; then
          echo "Available binaries:"
          ls -la "$PREFIX/bin/" | grep "$TARGET" || true
          
          # Test a binary
          if [ -f "$PREFIX/bin/${TARGET}-gcc" ] || [ -f "$PREFIX/bin/clang" ]; then
            echo "Toolchain appears to be installed correctly"
          fi
        fi
        
        # Create version info file
        echo "Toolchain type: $TOOLCHAIN_TYPE" > "$PREFIX/VERSION.txt"
        echo "Target: $TARGET" >> "$PREFIX/VERSION.txt"
        echo "Build date: $(date)" >> "$PREFIX/VERSION.txt"
        echo "GitHub Run ID: $GITHUB_RUN_ID" >> "$PREFIX/VERSION.txt"
        
        if [ "$TOOLCHAIN_TYPE" = "gcc" ]; then
          echo "GCC version: ${{ inputs.gcc_version }}" >> "$PREFIX/VERSION.txt"
          echo "Binutils version: ${{ inputs.binutils_version }}" >> "$PREFIX/VERSION.txt"
        else
          echo "LLVM version: ${{ inputs.llvm_version }}" >> "$PREFIX/VERSION.txt"
        fi
    
    - name: Package toolchain
      run: |
        export PREFIX="$INSTALL_PREFIX"
        export TARGET="${{ inputs.target_arch }}"
        export TOOLCHAIN_TYPE="${{ inputs.toolchain_type }}"
        
        # Create archive name
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        ARCHIVE_NAME="${TOOLCHAIN_TYPE}-${TARGET}-${TIMESTAMP}.tar.xz"
        
        # Package the installation
        cd "$(dirname "$PREFIX")"
        tar -cJf "$ARCHIVE_NAME" "$(basename "$PREFIX")"
        
        # Calculate checksum
        sha256sum "$ARCHIVE_NAME" > "${ARCHIVE_NAME}.sha256"
        
        # Move to workspace root
        mv "$ARCHIVE_NAME" "${ARCHIVE_NAME}.sha256" "$GITHUB_WORKSPACE/"
        
        echo "ARCHIVE_PATH=$GITHUB_WORKSPACE/$ARCHIVE_NAME" >> $GITHUB_ENV
        echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
    
    - name: Upload artifacts
      if: ${{ inputs.upload_artifacts }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.toolchain_type }}-${{ inputs.target_arch }}
        path: |
          ${{ env.ARCHIVE_PATH }}
          ${{ env.ARCHIVE_PATH }}.sha256
          ${{ env.INSTALL_PREFIX }}/VERSION.txt
        retention-days: 30
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.ARCHIVE_PATH }}
          ${{ env.ARCHIVE_PATH }}.sha256
        generate_release_notes: true
    
    - name: Upload to GitHub Packages
      if: ${{ inputs.upload_artifacts && github.event_name == 'workflow_dispatch' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Upload to GitHub Packages (optional)
        echo "Artifact created: $ARCHIVE_NAME"
        echo "Download URL will be available in Actions artifacts"
        
        # Alternatively, upload to releases if tagged
        if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
          gh release upload "${{ github.ref_name }}" "$ARCHIVE_NAME" "$ARCHIVE_NAME.sha256" \
            --repo "$GITHUB_REPOSITORY"
        fi