name: Build & Publish Toolchain Release

on:
  workflow_dispatch:
    inputs:
      gcc_version:
        description: 'GCC Version'
        required: true
        default: '13.2.0'
        type: string
      binutils_version:
        description: 'Binutils Version'
        required: true
        default: '2.42'
        type: string
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'x86_64-elf'
        type: choice
        options: 
          - x86_64-elf
          - aarch64-none-elf
          - i686-elf
          - riscv64-unknown-elf

# QUAN TRỌNG: Cấp quyền ghi (write) để Github Actions có thể tạo Release
permissions:
  contents: write

jobs:
  release-toolchain:
    name: Build ${{ inputs.target_arch }} GCC ${{ inputs.gcc_version }}
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. Dọn dẹp ổ đĩa (Như cũ)
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      # 2. Cài Dependencies (Như cũ)
      - name: Install Build Dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y \
            build-essential bison flex texinfo \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            wget tar

      # 3. Chạy Script Build
      - name: Run Build Script
        env:
          GCC_VERSION: ${{ inputs.gcc_version }}
          BINUTILS_VERSION: ${{ inputs.binutils_version }}
          TARGET: ${{ inputs.target_arch }}
        run: |
          chmod +x ./build_toolchain.sh
          ./build_toolchain.sh

      # 4. Tạo tên Tag động
      # Ví dụ Tag sẽ là: toolchain-x86_64-elf-gcc13.2.0
      - name: Generate Tag Name
        id: tag
        run: |
          TAG_NAME="toolchain-${{ inputs.target_arch }}-gcc${{ inputs.gcc_version }}"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      # 5. Tạo Release và Upload file
      - name: Create Release & Upload Asset
        uses: softprops/action-gh-release@v1
        with:
          # Tên tag (nếu chưa có sẽ tự tạo, nếu có rồi sẽ update)
          tag_name: ${{ env.TAG_NAME }}
          
          # Tiêu đề hiển thị của Release
          name: Cross-Toolchain ${{ inputs.target_arch }} (GCC ${{ inputs.gcc_version }})
          
          # Nội dung mô tả
          body: |
            Automated build via GitHub Actions.
            - **Date:** $(date)
            - **Target:** ${{ inputs.target_arch }}
            - **GCC:** ${{ inputs.gcc_version }}
            - **Binutils:** ${{ inputs.binutils_version }}
          
          # Đường dẫn tới file cần upload (do script bash tạo ra)
          files: toolchain_build/*.tar.gz
          
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}