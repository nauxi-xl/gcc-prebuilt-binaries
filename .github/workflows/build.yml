name: Multi-Arch Toolchain Release

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release Tag Name'
        default: 'manual-build'

permissions:
  contents: write

jobs:
  build-matrix:
    name: Build ${{ matrix.tool }} (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool: [gcc, llvm]
        arch: 
          - x86_64-elf          # Standard PC
          - aarch64-none-elf    # ARM64 (Raspberry Pi 3/4/5, Apple Silicon VMs)
          - riscv64-unknown-elf # RISC-V 64-bit (VisionFive 2, QEMU Virt)
          - i686-elf            # PC 32-bit (Legacy)

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bison flex texinfo \
            libgmp-dev libmpfr-dev libmpc-dev \
            cmake ninja-build python3 zlib1g-dev

      - name: Determine Build Arguments
        id: args
        run: |
          if [ "${{ matrix.tool }}" == "gcc" ]; then
             echo "BUILD_CMD=--toolchain=gcc --target=${{ matrix.arch }} --enable-libc=none" >> $GITHUB_OUTPUT
          else
             # Với LLVM: Build Clang + LLD + Runtimes cho target đó
             echo "BUILD_CMD=--toolchain=llvm --target=${{ matrix.arch }} --llvm-projects='clang;lld;compiler-rt;libcxx;libcxxabi;libunwind'" >> $GITHUB_OUTPUT
          fi

      - name: Run Build
        run: |
          chmod +x ./build_toolchain.sh
          # Gọi script với tham số động từ bước trên
          ./build_toolchain.sh ${{ steps.args.outputs.BUILD_CMD }} --prefix=${{ github.workspace }}/install --jobs=$(nproc)

      - name: Package
        run: |
          cd ${{ github.workspace }}/install
          TAR_NAME="${{ matrix.arch }}-${{ matrix.tool }}.tar.gz"
          tar -czvf ../$TAR_NAME .
          echo "ARTIFACT_NAME=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}

  release:
    name: Create Release
    needs: build-matrix
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          name: Cross-Toolchain ${{ github.event.inputs.tag_name || github.ref_name }}
          files: artifacts/*.tar.gz